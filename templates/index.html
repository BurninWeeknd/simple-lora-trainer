{% extends "base.html" %}
{% block content %}

{% set model = config.get('model', {}) if config else {} %}

<h1>LoRA Trainer</h1>

<form method="get">
    <label>Project:</label>
    <select name="project" onchange="this.form.submit()">
        <option value="">-- select --</option>
        {% for p in projects %}
            <option value="{{ p }}" {% if p == selected %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
    </select>
</form>

<form method="post" action="{{ url_for('create_project_route') }}" style="margin-top: 16px;">
  <label>
    New Project
    <span class="tooltip"
          data-tip="Creates a new LoRA project folder with default configuration.">
      ⓘ
    </span>
  </label><br>

  <input type="text"
         name="project_name"
         placeholder="Project name"
         required>

  <button type="submit" style="margin-left: 8px;">
    Create
  </button>
</form>

{% if selected %}
<div class="section danger-zone">
  <div class="danger-title">Danger Zone</div>

  <form method="post" action="{{ url_for('delete_project_route') }}">
    <input type="hidden" name="project_name" value="{{ selected }}">

    <label>
      Type <strong>{{ selected }}</strong> to delete this project
      <span class="tooltip"
            data-tip="This permanently deletes the project folder and config. This cannot be undone.">
        ⓘ
      </span>
    </label><br>

    <input name="confirm_name" type="text" placeholder="Project name">
    <br><br>

    <button type="submit" class="danger">
      Delete Project
    </button>
  </form>
</div>
{% endif %}

{% if config %}
<hr>

<form method="post">
<input type="hidden" name="project" value="{{ selected }}">

{% set dataset = config.get('dataset', {}) %}
{% set captions = dataset.get('captions', {}) %}
{% set bucket = dataset.get('bucket', {}) %}
{% set training = config.get('training', {}) %}
{% set lrs = training.get('learning_rates', {}) %}
{% set cond = training.get('conditioning', {}) %}
{% set lora = config.get('lora', {}) %}
{% set precision = config.get('precision', {}) %}
{% set optimizer = config.get('optimizer', {}) %}
{% set betas = optimizer.get('betas', []) %}
{% set scheduler = config.get('scheduler', {}) %}

<div class="section">
<h2>Model</h2>

<label>
  Architecture
  <span class="tooltip"
        data-tip="Select the base model this LoRA is trained for. SDXL requires more VRAM than SD 1.5.">
    ⓘ
  </span>
</label><br>

<select name="model_architecture">
  <option value="sdxl"
    {% if model.get('architecture', 'sdxl') == "sdxl" %}selected{% endif %}>
    SDXL
  </option>
  <option value="sd15"
    {% if model.get('architecture') == "sd15" %}selected{% endif %}>
    SD 1.5
  </option>
</select>

<br><br>

<label>
  Checkpoint (optional)
  <span class="tooltip"
        data-tip="Optional base checkpoint path. Leave empty to use trainer default.">
    ⓘ
  </span>
</label><br>

<input name="model_checkpoint" type="text"
       value="{{ model.get('checkpoint', '') }}">

<!-- ===================== DATASET ===================== -->

<div class="section">
<h2>Dataset</h2>

<label>Dataset Path</label><br>
<input name="dataset_path" type="text" value="{{ dataset.get('path','') }}">
<br><br>

<label>Resolution</label><br>
<input name="resolution" type="number" value="{{ dataset.get('resolution','') }}">
<br><br>

<label>Repeats</label><br>
<input name="repeats" type="number" value="{{ dataset.get('repeats','') }}">
<br><br>

<label>
  Batch Size
  <span class="tooltip"
        data-tip="Number of images processed per training step. Higher values use more VRAM.">
    ⓘ
  </span>
</label><br>
<input name="batch_size" type="number"
       value="{{ dataset.get('batch_size','') }}"
       class="{% if 'batch_size' in danger_fields %}danger{% endif %}">
<br><br>

<label>
  <input type="checkbox" name="shuffle" {% if dataset.get('shuffle') %}checked{% endif %}>
  Shuffle Dataset
</label>
<br><br>

<label>
  <input type="checkbox" name="cache_latents" {% if dataset.get('cache_latents') %}checked{% endif %}>
  Cache Latents
</label>

<hr>

<h3>Captions</h3>

<label>Extension</label><br>
<input name="caption_extension" type="text" value="{{ captions.get('extension','') }}">
<br><br>

<label>
  <input type="checkbox" name="first_word_memorize"
         {% if captions.get('first_word_memorize') %}checked{% endif %}>
  Memorize First Caption Word
</label>
<br><br>

<label>Prepend Token</label><br>
<input name="prepend_token" type="text" value="{{ captions.get('prepend_token','') }}">
<br><br>

<label>Append Token</label><br>
<input name="append_token" type="text" value="{{ captions.get('append_token','') }}">

<hr>

<h3>Bucketing</h3>

<label>
  <input type="checkbox" name="bucket_enabled" {% if bucket.get('enabled') %}checked{% endif %}>
  Enable Bucketing
</label>
<br><br>

<label>Min Resolution</label><br>
<input name="bucket_min_res" type="number" value="{{ bucket.get('min_res','') }}">
<br><br>

<label>Max Resolution</label><br>
<input name="bucket_max_res" type="number" value="{{ bucket.get('max_res','') }}">
<br><br>

<label>Step</label><br>
<input name="bucket_step" type="number" value="{{ bucket.get('step','') }}">

<hr>
</div>

<!-- ===================== TRAINING ===================== -->

<div class="section">
<h2>Training</h2>

<label>
  Epochs
  <span class="tooltip"
        data-tip="Number of full passes over the dataset. More epochs increase training time and risk of overfitting.">
    ⓘ
  </span>
</label><br>
<input name="epochs" type="number"
       value="{{ training.get('epochs','') }}"
       class="{% if 'epochs' in danger_fields %}danger{% endif %}">
<br><br>

<label>Gradient Accumulation</label><br>
<input name="gradient_accumulation" type="number"
       value="{{ training.get('gradient_accumulation','') }}">
<br><br>

<label>
  CLIP Skip
  <span class="tooltip"
        data-tip="Skips early CLIP layers. Higher values reduce literal prompt matching and can weaken concept learning.">
    ⓘ
  </span>
</label><br>
<input name="clip_skip" type="number"
       value="{{ cond.get('clip_skip','') }}">
<br><br>

<h3>Learning Rates</h3>

<label>
  UNet LR
  <span class="tooltip"
        data-tip="Learning rate for UNet weights. Typical range is 1e-5 to 5e-5. Too high can destroy training.">
    ⓘ
  </span>
</label><br>
<input name="lr_unet" type="text"
       value="{{ lrs.get('unet','') }}"
       class="{% if 'lr_unet' in danger_fields %}danger{% endif %}">
<br><br>

<label>
  CLIP LR
  <span class="tooltip"
        data-tip="Learning rate for CLIP text encoder. Usually equal to or lower than UNet LR. Higher values can harm prompt understanding.">
    ⓘ
  </span>
</label><br>
<input name="lr_clip" type="text"
       value="{{ lrs.get('clip','') }}"
       class="{% if 'lr_clip' in danger_fields %}danger{% endif %}">
<br><br>

<label>T5 LR</label><br>
<input name="lr_t5" type="text"
       value="{{ lrs.get('t5','') }}"
       class="{% if 'lr_t5' in danger_fields %}danger{% endif %}">

<hr>
</div>

<!-- ===================== LoRA ===================== -->

<div class="section">
<h2>LoRA</h2>

<label>
  Rank
  <span class="tooltip"
        data-tip="Controls LoRA capacity. Higher values increase file size and training time. Common values are 8, 16, 32, or 64.">
    ⓘ
  </span>
</label><br>
<input name="lora_rank" type="number" value="{{ lora.get('rank','') }}">
<br><br>

<label>Alpha</label><br>
<input name="lora_alpha" type="number" value="{{ lora.get('alpha','') }}">
<br><br>

<label>Dropout</label><br>
<input name="lora_dropout" type="text" value="{{ lora.get('dropout','') }}">
<br><br>

<label>Target Modules</label><br>
<input name="lora_target_modules" type="text" value="{{ lora.get('target_modules','') }}">
<br><br>

<label>Bias</label><br>
<select name="lora_bias">
{% for opt in ["none","all","lora_only"] %}
  <option value="{{ opt }}" {% if lora.get('bias') == opt %}selected{% endif %}>{{ opt }}</option>
{% endfor %}
</select>

<hr>
</div>

<!-- ===================== PRECISION ===================== -->

<div class="section">
<h2>Precision</h2>

<label>Mixed Precision</label><br>
<select name="mixed_precision">
{% for opt in ["fp16","bf16","fp32"] %}
  <option value="{{ opt }}" {% if precision.get('mixed_precision') == opt %}selected{% endif %}>{{ opt }}</option>
{% endfor %}
</select>
<br><br>

<label>
  <input type="checkbox" name="gradient_checkpointing"
         {% if precision.get('gradient_checkpointing') %}checked{% endif %}>
  Gradient Checkpointing
</label>
<br><br>

<label>
  <input type="checkbox" name="xformers"
         {% if precision.get('xformers') %}checked{% endif %}>
  Use xFormers
</label>
<br><br>

<label>
  <input type="checkbox" name="cpu_offload"
         {% if precision.get('cpu_offload') %}checked{% endif %}>
  CPU Offload
</label>

<hr>
</div>

<!-- ===================== OPTIMIZER ===================== -->

<div class="section">
<h2>Optimizer</h2>

<label>Optimizer Type</label><br>
<select name="optimizer_type">
{% for opt in ["adamw","adam","sgd"] %}
  <option value="{{ opt }}" {% if optimizer.get('type') == opt %}selected{% endif %}>{{ opt }}</option>
{% endfor %}
</select>
<br><br>

<label>Weight Decay</label><br>
<input name="weight_decay" type="text" value="{{ optimizer.get('weight_decay','') }}">
<br><br>

<label>Beta 1</label><br>
<input name="beta1" type="text" value="{{ betas[0] if betas|length > 0 else '' }}">
<br><br>

<label>Beta 2</label><br>
<input name="beta2" type="text" value="{{ betas[1] if betas|length > 1 else '' }}">
<br><br>

<label>Epsilon</label><br>
<input name="epsilon" type="text" value="{{ optimizer.get('epsilon','') }}">

<hr>
</div>

<!-- ===================== SCHEDULER ===================== -->

<div class="section">
<h2>Scheduler</h2>

<label>Scheduler Type</label><br>
<select name="scheduler_type">
{% for opt in ["cosine","linear","constant"] %}
  <option value="{{ opt }}" {% if scheduler.get('type') == opt %}selected{% endif %}>{{ opt }}</option>
{% endfor %}
</select>
<br><br>

<label>Warmup Steps</label><br>
<input name="warmup_steps" type="number" value="{{ scheduler.get('warmup_steps','') }}">
<br><br>

<label>Num Cycles</label><br>
<input name="num_cycles" type="number" value="{{ scheduler.get('num_cycles','') }}">

<hr>
</div>

<!-- ===================== TRAINING ===================== -->

<div class="section">
  <h2>Training</h2>

  <p style="color: var(--muted); margin-bottom: 12px;">
    Uses the current configuration to start LoRA training.
  </p>

  <button
    type="submit"
    name="action"
    value="train"
    class="train-button"
  >
    ▶ Start Training
  </button>

  {% if vram_estimate %}
  <div style="margin-top: 12px; color: var(--muted);">
    Estimated VRAM usage:
    <strong>{{ "%.1f"|format(vram_estimate) }} GB</strong>
  </div>
{% endif %}

{% if vram_estimate %}
  <div style="margin-top: 12px;">
    Estimated VRAM usage:
    <strong>{{ "%.1f"|format(vram_estimate) }} GB</strong>
  </div>
  <div style="font-size: 13px; color: var(--muted);">
    Actual usage may vary by ±2 GB depending on GPU, drivers, and model.
  </div>
{% endif %}
</div>

<!-- ===================== SAVE ===================== -->

{% if issues %}
  <div class="warning-box">
    {% for i in issues %}<div>{{ i.message }}</div>{% endfor %}
  </div>
  {% if danger_fields %}
    <button name="confirm" value="yes">Proceed Anyway</button>
    <button type="submit">Cancel</button>
  {% else %}
    <button type="submit">Save</button>
  {% endif %}
{% else %}
  <button type="submit">Save</button>
{% endif %}

</form>

<script>
const danger = document.querySelector(".danger");
if (danger) danger.scrollIntoView({behavior:"smooth", block:"center"});
</script>

{% endif %}
{% endblock %}
